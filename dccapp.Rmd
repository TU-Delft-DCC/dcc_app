---
title: "DCC Reporting Dashboard"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      bootswatch: lumen
      primary: '#00A6D6'
      info: '#0C2340'
      success: '#00B8C8'
      warning: '#FFB81C'
      danger: '#E03C31'
    css: custom.css
    orientation: rows
    social: menu
    source_code: "https://github.com/TU-Delft-DCC/dcc_app"
---


```{r setup, include=FALSE}

# Package names
#packages <- c("flexdashboard", "remotes", "googlesheets4", "plotly", "bslib", "data.table", "shiny", "shinyWidgets", "shinydashboard", "shinyjs", "here", "tidyverse", "highcharter")

library(rsconnect)
library(flexdashboard)
library(remotes)
library(googlesheets4)
library(plotly)
library(bslib)
library(data.table)
library(shiny)
library(shinyWidgets)
library(shinydashboard)
library(shinyjs)
library(here)
library(tidyverse)
library(highcharter)


# Install packages not yet installed
#installed_packages <- packages %in% rownames(installed.packages())
 #if (any(installed_packages == FALSE)) {
  #install.packages(packages[!installed_packages])
#}

# Packages loading
#invisible(lapply(packages, library, character.only = TRUE))

# documentation for flexdashboard options: https://rstudio.github.io/flexdashboard/articles/using.html 

# Get the auxiliary info from the tool_kit file
source(here('plot_kit.R'))

# Set the  gpplot theme 
theme_set(dcc_theme)


```


```{r global, include = FALSE}
# The data is public and does not need authentication
gs4_deauth()

dt <- as.data.table(read_sheet("https://docs.google.com/spreadsheets/d/1pEdWUvcnKMdp0KD5XpEhleFqA7hAbDm6VxagN0yTqMU/edit?usp=sharing"))

dt$date_approx <- factor(dt$date_approx, levels = c("Spring 2021", "Summer 2021", "Fall 2021", "Spring 2022", "Fall 2022"))

```

# Sidebar {.sidebar}

### Projects by the DCC

**This is a reporting dashboard for projects completed by the TU Delft Digital Competence Centre (DCC)**.  

For further information about how the DCC can support your FAIR research data management and software development needs, please visit our website at [dcc.tudelft.nl](dcc.tudelft.nl). Documentation and guidance on computing, data, and software for research at TU Delft are maintained on our [DCC Guides](https://tu-delft-dcc.github.io/welcome.html).

### Search

Select from the options below to filter data by support round, faculty, support type, and support status.

***Note:** Deselect "All" to see subsetted data*.

```{r filters}
# dateRangeInput("daterange", "Select date range:",
 #                 start  =  min(wd_data3_sum$APPROVED_DATE),
 #                 end    =  max(wd_data3_sum$APPROVED_DATE),
 #                 min    =  min(wd_data3_sum$APPROVED_DATE),
 #                 max    =  max(wd_data3_sum$APPROVED_DATE),
 #                 format = "dd M yyyy",
 #                 separator = " - ")

#interesting plugin : selectsize: https://stackoverflow.com/questions/60831030/shiny-reactive-selectinput-in-r

 # selectInput("round", label = "Select DCC support round:",
 #             choices = sort(unique(dt$dcc_support_round )), multiple = T, 
 #             selected = sort(unique(dt$dcc_support_round )) 
 #             )


 pickerInput("date_approx","Select DCC support round:", 
              choices= c("All", sort(unique(dt$date_approx))),
              selected = "All",
              multiple = TRUE,
              )

 pickerInput("faculty","Select faculty:", 
             choices= c("All", sort(unique(dt$faculty))),
             selected = "All",
             multiple = TRUE,
             )
 
 pickerInput('support_type', 'Select support type', 
             choices = c('All',sort(unique(dt$support_type))),
             selected = "All",
             multiple = TRUE,
            ) 
 
 pickerInput('status', label='Select support status', 
            choices = c('All', sort(unique(dt$status))),
            selected= "All",
            multiple=TRUE,
            )
```

***Last modified:** 1 November 2022*

```{r filtered-data}
#  Redefining the dataset based on the inputs

dt_selected<-reactive({
  dt_selected <- dt[(date_approx %in% if("All" %in% input$date_approx) unique(dt[,date_approx])  else input$date_approx )
     & (faculty %in% if ("All" %in% input$faculty) unique(dt[,faculty]) else input$faculty)
     & (support_type %in% if("All" %in% input$support_type) unique(dt[,support_type])  else input$support_type )
     & (status %in% if("All" %in% input$status) unique(dt[,status])  else input$status ) 
     ]
  
  dt_selected[,counter:=1]
  
  dt_selected
  
  })

```


# Hosted by the TU Delft Digital Competence Centre

## Row

### Requests received {.value-box}

```{r vbox-nrows}


flexdashboard::renderValueBox({
  requests <- nrow(dt_selected()) %>% prettyNum(big.mark = ",")
  flexdashboard::valueBox(
    value = requests,
    icon = "fa-list",
    color = "#E0E0E0"
    )
  })
```

### Projects completed {.value-box}

```{r vbox-completed}
flexdashboard::renderValueBox({
  completed <- sum(dt_selected()$status == "Completed")  %>% prettyNum(big.mark = ",")
  flexdashboard::valueBox(
    value = completed,
    icon = "fa-thumbs-up",
    color = "#E0E0E0"
  )
})
```

### Projects running {.value-box}

```{r vbox-running}
flexdashboard::renderValueBox({
  running <- sum(dt_selected()$status == "Running")  %>% prettyNum(big.mark = ",")
  flexdashboard::valueBox(
    value = running,
    icon = "fa-spinner",
    color = "#E0E0E0"
  )
})
```

## Row

### Hours assigned {.value-box}

```{r vbox-hrs}
flexdashboard::renderValueBox({
  assigned <- sum(dt_selected()$hours_assigned, na.rm = TRUE)  %>% prettyNum(big.mark = ",")
  flexdashboard::valueBox(
    value = assigned,
    icon = "fa-clock",
    color = "#E0E0E0"
  )
})
```

### Average hours assigned per project {.value-box}

```{r vbox-team}
flexdashboard::renderValueBox({
  team <- round(sum(dt_selected()$hours_assigned, na.rm = TRUE) /  nrow(dt_selected())) %>% prettyNum(big.mark = ",") 
  flexdashboard::valueBox(
    value = team,
    icon = "fa-hourglass-clock",
    color = "warning"
  )
})
```

### Number of applicants {.value-box}

```{r vbox-applicants}
flexdashboard::renderValueBox({
  applicants <- length(unique(dt_selected()[["applicant_id"]])) %>% prettyNum(big.mark = ",")
  flexdashboard::valueBox(
    value = applicants,
    icon = "fa-user-plus",
    color = "#E0E0E0"
  )
})
```



### Requests per support round 

```{r bar-round}
# Useful highcharter reference: https://www.tmbish.me/lab/highcharter-cookbook/

renderHighchart({
  
x <- dt_selected()[,.N, by = dcc_support_round][order(dcc_support_round)]
x[ ,dcc_support_round := factor(dcc_support_round, levels = sort(unique(dcc_support_round))) ] 

 x %>% 
  hchart('column', hcaes(x = dcc_support_round, y =  N  ), innerSize = 50, 
         dataLabels = list(enabled = TRUE, position = 'center' ,  inside = T, style = list(textOutline = F) ) ) %>%
  hc_add_theme(dcc_hc_theme) %>%
  hc_yAxis(title = list(text = ""#"Number of applications"
                        )) %>%
  hc_xAxis(title = list(text = ""#"Support round"
                        )) 
 
})
```

### Applications per Status 

```{r pie-status}

renderHighchart({
  if (nrow(dt_selected()) != 0){
  x <- dt_selected()[,.N, by = status]
  x[,PCT:=round(N/sum(N) *100)] 
  
 
  hc <- x %>%
  hchart("pie", hcaes(x = status, y = PCT)) %>%
  hc_tooltip(crosshairs = TRUE, borderWidth = 5, sort = TRUE, shared = TRUE, table = TRUE,
             pointFormat = paste('<b>: {point.percentage:.1f}%</b>')) %>%
  #hc_colors(tud_qual) %>%
  hc_add_theme(dcc_hc_theme)
 
  hc 
 }
})

```


### Projects by faculty 

```{r hcbar-faculty}

renderHighchart({
  if (nrow(dt_selected()) != 0){
  # x <- melt(dt_selected(), id.vars = "faculty",
  #               measure.vars = c("hours_assigned", "counter"))
  # x <- x[, .(value = sum(value, na.rm = T)), by = .(faculty, variable)]
  #vars <- c("hours_assigned", "counter")  
  #x <- dt_selected[lapply() ]
  

  highchart() %>% 
  hc_yAxis_multiples(list(title = list(text = "Price"), opposite = FALSE),
                     list(showLastLabel = FALSE, opposite = TRUE, title = list(text = "Volume"))) %>%
  hc_add_series(data = dt_selected$hours_assigned, type = 'column') %>% 
  hc_add_series(data = dt_selected$counter, yAxis = 1, type = 'column')

  }  
})

```



