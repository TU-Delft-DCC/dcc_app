---
title: "DCC Reporting Dashboard"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      bootswatch: lumen
    css: custom.css
    orientation: rows
    social: menu
    source_code: "https://github.com/TU-Delft-DCC/dcc_app"
---


```{r setup, include=FALSE}

# Package names
#packages <- c("flexdashboard", "remotes", "googlesheets4", "plotly", "bslib", "data.table", "shiny", "shinyWidgets", "shinydashboard", "shinyjs", "here", "tidyverse", "highcharter")

library(rsconnect)
library(flexdashboard)
library(remotes)
library(googlesheets4)
library(plotly)
library(bslib)
library(data.table)
library(shiny)
library(shinyWidgets)
library(shinydashboard)
library(shinyjs)
library(here)
library(tidyverse)
library(highcharter)


# Install packages not yet installed
#installed_packages <- packages %in% rownames(installed.packages())
 #if (any(installed_packages == FALSE)) {
  #install.packages(packages[!installed_packages])
#}

# Packages loading
#invisible(lapply(packages, library, character.only = TRUE))

# documentation for flexdashboard options: https://rstudio.github.io/flexdashboard/articles/using.html 

# Add theme customizer for experimentation with themes
#bslib::bs_themer()


# Get the auxiliary info from the tool_kit file
source(here('plot_kit.R'))

# Set the  gpplot theme 

theme_set(theme_minimal() + 
            theme(panel.grid.major.x = element_blank())
          )


```


```{r global, include = FALSE}
# The data is public and does not need authentication
gs4_deauth()

dt <- as.data.table(read_sheet("https://docs.google.com/spreadsheets/d/1pEdWUvcnKMdp0KD5XpEhleFqA7hAbDm6VxagN0yTqMU/edit?usp=sharing"))
```

# Sidebar {.sidebar}

### Projects by the DCC

**This is a reporting dashboard for projects completed by the TU Delft Digital Competence Centre (DCC)**.  

For further information about how the DCC can support your FAIR research data management and software development needs, please visit our website at [dcc.tudelft.nl](dcc.tudelft.nl). 

### Search

Select from the options below to filter data by support round, faculty, support type, and support status.

***Note:** Deselect "All" to see subsetted data*.

```{r filters}
# dateRangeInput("daterange", "Select date range:",
 #                 start  =  min(wd_data3_sum$APPROVED_DATE),
 #                 end    =  max(wd_data3_sum$APPROVED_DATE),
 #                 min    =  min(wd_data3_sum$APPROVED_DATE),
 #                 max    =  max(wd_data3_sum$APPROVED_DATE),
 #                 format = "dd M yyyy",
 #                 separator = " - ")

#interesting plugin : selectsize: https://stackoverflow.com/questions/60831030/shiny-reactive-selectinput-in-r

 # selectInput("round", label = "Select DCC support round:",
 #             choices = sort(unique(dt$dcc_support_round )), multiple = T, 
 #             selected = sort(unique(dt$dcc_support_round )) 
 #             )


 pickerInput("dcc_support_round","Select DCC support round:", 
             choices= c("All", sort(unique(dt$dcc_support_round))),
             selected = "All",
             multiple = TRUE,
             )

 pickerInput("faculty","Select faculty:", 
             choices= c("All", sort(unique(dt$faculty))),
             selected = "All",
             multiple = TRUE,
             )
 
 pickerInput('support_type', 'Select support type', 
             choices = c('All',sort(unique(dt$support_type))),
             selected = "All",
             multiple = TRUE,
            ) 
 
 pickerInput('status', label='Select support status', 
            choices = c('All', sort(unique(dt$status))),
            selected= "All",
            multiple=TRUE,
            )
```

***Last modified:** 1 November 2022*

```{r filtered-data}
#  Redefining the dataset based on the inputs

# filter_faculty <- (faculty %in% if(input$faculty == 'All') unique(dt[,faculty])  else input$faculty )


dt_selected<-reactive({
  dt_selected <- dt[(dcc_support_round %in% if("All" %in% input$dcc_support_round) unique(dt[,dcc_support_round])  else input$dcc_support_round )
     & (faculty %in% if ("All" %in% input$faculty) unique(dt[,faculty]) else input$faculty)
     & (support_type %in% if("All" %in% input$support_type) unique(dt[,support_type])  else input$support_type )
     & (status %in% if("All" %in% input$status) unique(dt[,status])  else input$status ) 
     ]
  
  dt_selected[,counter:=1]
  
  dt_selected
  
  })

```


# Hosted by the TU Delft Digital Competence Centre

## Row

### Requests processed {.value-box}

```{r vbox-nrows}


flexdashboard::renderValueBox({
  requests <- nrow(dt_selected())
  flexdashboard::valueBox(
    value = requests,
    icon = "fa-list",
    color = "#E0E0E0"
    )
  })
```

### Projects completed {.value-box}

```{r vbox-completed}
flexdashboard::renderValueBox({
  completed <- sum(dt_selected()$status == "Completed")
  flexdashboard::valueBox(
    value = completed,
    icon = "fa-thumbs-up",
    color = "#E0E0E0"
  )
})
```

### Projects running {.value-box}

```{r vbox-running}
flexdashboard::renderValueBox({
  running <- sum(dt_selected()$status == "Running")
  flexdashboard::valueBox(
    value = running,
    icon = "fa-spinner",
    color = "#E0E0E0"
  )
})
```

## Row

### Hours assigned {.value-box}

```{r vbox-hrs}
flexdashboard::renderValueBox({
  assigned <- sum(dt_selected()$hours_assigned, na.rm = TRUE)
  flexdashboard::valueBox(
    value = assigned,
    icon = "fa-clock",
    color = "#E0E0E0"
  )
})
```

### Team members {.value-box}

```{r vbox-team}
flexdashboard::renderValueBox({
  team <- 8 #static number
  flexdashboard::valueBox(
    value = team,
    icon = "fa-user",
    color = "#E0E0E0"
  )
})
```

### Number of applicants {.value-box}

```{r vbox-applicants}
flexdashboard::renderValueBox({
  applicants <- length(unique(dt_selected()[["applicant_id"]]))
  flexdashboard::valueBox(
    value = applicants,
    icon = "fa-user-plus",
    color = "#E0E0E0"
  )
})
```


Row 
-------------------------------------

### Applications Received vs. Hours Assigned per Faculty

```{r bar-faculty}

renderPlotly({
  # Create the data for the plot (wide to long)
  if (nrow(dt_selected()) != 0){
  x <- melt(dt_selected(), id.vars = "faculty",
                measure.vars = c("hours_assigned", "counter"))
  x <- x[, .(value = sum(value, na.rm = T)), by = .(faculty, variable)]|> mutate(scaled_value=ifelse(variable=="hours_assigned",value,value*100)) |>
    mutate(variable = recode(variable, hours_assigned = 'Hours Assigned', counter = 'Applications Received'))

ay <- list(
  tickfont = list(size=11.7),
  # titlefont=list(size=14),
  overlaying = "y",
  side = "right",
  color = "gray63",
  title = ""
)

colors <- c(tud_qual[1], tud_qual[2])
  
  p <- ggplot(data = x, aes(x = reorder(faculty,-value) , y = scaled_value, fill = variable, text = paste(" Faculty :", faculty, "<br>", variable, ":", value))) + 
    geom_col(position = position_dodge2(reverse = TRUE)) + 
    scale_y_continuous(limits = c(0,max(x$scaled_value))) +
    scale_fill_manual(values = colors, name = "") +
    xlab("") 
  
  ggplotly(p, tooltip = "text") %>%
    add_lines(x=~reorder(faculty,-value), y=~scaled_value/100, colors=NULL, yaxis="y2", 
            data=x, showlegend=FALSE, inherit=FALSE) %>%
         layout(yaxis2 = ay,
                xaxis = list(title = ""),
                yaxis = list(title="")) %>%
    layout(xaxis = list(
            zerolinecolor = '#ffff',
            zerolinewidth = 2,
            gridcolor = 'ffff'),
          yaxis = list(
            zerolinecolor = '#ffff',
            zerolinewidth = 2,
            gridcolor = 'ffff')
          )
                
  }  
})

```

Row
-------------------------------------

### Applications Received per Round

```{r bar-round}

renderPlotly({
  if (nrow(dt_selected()) != 0){
  p <- ggplot(data = dt_selected(), aes(x = as.factor(dcc_support_round), text = paste(" No. of Applications :", "count"))) +
  geom_bar(fill = tud_col_prim[1] )+
    geom_text(stat = "count",
              position = position_stack(vjust = 0.5),
              aes(label = after_stat(count)),
              color = 'white')+
    theme(panel.grid.minor = element_blank(),
          axis.title = element_blank()) 
    
  
  ggplotly(p, tooltip = FALSE)
  }
})

```

### Applications per Status 

```{r pie-status}

renderHighchart({
  if (nrow(dt_selected()) != 0){
  x <- dt_selected()[,.N, by = status]
  x[,PCT:=round(N/sum(N) *100)] 
  
 
  hc <- x %>%
  hchart("pie", hcaes(x = status, y = PCT)) %>%
  hc_tooltip(crosshairs = TRUE, borderWidth = 5, sort = TRUE, shared = TRUE, table = TRUE,
             pointFormat = paste('<b>: {point.percentage:.1f}%</b>')) %>%
  hc_colors(unlist(tud_qual, use.names = F) )
 
  hc 
 }
})

```



